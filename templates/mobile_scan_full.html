<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root {
      --bg: #f2faff;
      --text: #222;
      --accent: #007acc;
      --box: #fff;
      --success: #28a745;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --text: #eee;
      --accent: #00cfff;
      --box: #1f1f1f;
      --success: #00e676;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      text-align: center;
      padding: 30px;
      direction: rtl;
      transition: background 0.3s ease, color 0.3s ease;
    }

    h1 { color: var(--accent); margin-bottom: 10px; }

    #reader {
      width: 100%;
      max-width: 360px;
      margin: 20px auto;
      display: none;
      border: 2px solid var(--accent);
      border-radius: 10px;
      padding: 10px;
      background-color: var(--box);
    }

    #status {
      font-size: 16px;
      margin-top: 20px;
      color: var(--accent);
    }

    #scannedText {
      margin-top: 20px;
      font-size: 16px;
      color: var(--success);
    }

    #cameraSelect, #resolutionSelect {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .start-btn {
      margin-top: 15px;
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    .theme-toggle {
      position: absolute;
      top: 20px;
      left: 20px;
      background: transparent;
      color: var(--text);
      border: 2px solid var(--accent);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }

    .theme-toggle:hover {
      background: var(--accent);
      color: white;
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…</button>
  <h1>ğŸ“¦ Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h1>

  <select id="cameraSelect"></select>
  <select id="resolutionSelect">
    <option value="320x240">Ù…Ù†Ø®ÙØ¶Ø© 320x240</option>
    <option value="640x480" selected>Ù…ØªÙˆØ³Ø·Ø© 640x480</option>
    <option value="1280x720">Ø¹Ø§Ù„ÙŠØ© 1280x720</option>
  </select>
  <button class="start-btn" onclick="startSelectedCamera()">ğŸ¬ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</button>

  <div id="reader"></div>
  <div id="status">ğŸ“¸ Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</div>
  <div id="scannedText"></div>

  <script>
    const reader = new Html5Qrcode("reader");
    const cameraSelect = document.getElementById("cameraSelect");
    const resolutionSelect = document.getElementById("resolutionSelect");

    function onScanSuccess(decodedText) {
      document.getElementById("scannedText").innerText = `âœ… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${decodedText}`;
      document.getElementById("status").innerText = "ğŸ”„ Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù†ØªØ¬...";

      reader.stop().then(() => {
        fetch("/api/auto_add_product?barcode=" + encodeURIComponent(decodedText))
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              window.location.href = "/enter_expiration_date?barcode=" + encodeURIComponent(decodedText);
            } else {
              document.getElementById("status").innerText = "âŒ " + (data.message || "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬.");
            }
          })
          .catch(() => {
            document.getElementById("status").innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….";
          });
      });
    }

    function onScanFailure() {}

    function parseResolution(value) {
      const [w, h] = value.split("x").map(Number);
      return { width: w, height: h };
    }

    function startSelectedCamera() {
      const selectedId = cameraSelect.value;
      const resolution = parseResolution(resolutionSelect.value);
      if (!selectedId) {
        alert("â— Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }

      document.getElementById("reader").style.display = "block";
      reader.start(
        { deviceId: { exact: selectedId } },
        {
          fps: 10,
          qrbox: 250,
          ...resolution,
          formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.CODE_128
          ]
        },
        onScanSuccess,
        onScanFailure
      ).then(() => {
        document.getElementById("status").innerText = "ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...";
      }).catch(err => {
        document.getElementById("status").innerText = "âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err;
      });
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        document.getElementById("status").innerText = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§.";
        return;
      }

      devices.forEach(cam => {
        const option = document.createElement("option");
        option.value = cam.id;
        option.text = cam.label || "ÙƒØ§Ù…ÙŠØ±Ø§";
        cameraSelect.appendChild(option);
      });

      document.getElementById("status").innerText = "âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø­.";
    }).catch(() => {
      document.getElementById("status").innerText = "âŒ ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.";
    });

    function toggleTheme() {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      document.documentElement.setAttribute("data-theme", isDark ? "light" : "dark");
      localStorage.setItem("theme_mode", isDark ? "light" : "dark");
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ù…Ù† localStorage
    const savedTheme = localStorage.getItem("theme_mode");
    if (savedTheme) {
      document.documentElement.setAttribute("data-theme", savedTheme);
    }
  </script>
</body>
</html>
